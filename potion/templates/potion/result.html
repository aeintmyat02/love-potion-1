{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>My Valentine Letter</title>

<link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@700&family=Patrick+Hand&family=Playfair+Display:wght@400;700&display=swap" rel="stylesheet">

<style>
body{
    margin:0;
    padding:0;
    font-family:"Playfair Display", serif;
    background: linear-gradient(135deg,#fff0f8,#ffe0e6);
    text-align:center;
    color:#740e28;
}

/* Small decorative emoji header */
#pageHeader{
    font-size:3em;
    margin-top:30px;
}

/* Question box */
#questionBox{
    margin-top:40px;
    position:relative;
    height:200px;
}

#questionBox h2{
    font-family:'Dancing Script', cursive;
    font-size:2.8em;
    color:#d97f8b;
}

/* Buttons */
button{
    padding:12px 25px;
    border:none;
    border-radius:18px;
    background:#d97f8b;
    color:#fff;
    font-size:1.1em;
    cursor:pointer;
    box-shadow:0 6px 18px rgba(217,127,139,0.4);
    transition: transform 0.3s, background 0.3s;
    margin:10px;
}
button:hover{
    background:#ffc2be;
    color:#740e28;
    transform: scale(1.05);
}

/* Moving No button */
#noBtn{
    position:absolute;
}

/* Envelope */
.envelope{
    width:340px;
    height:220px;
    margin:40px auto;
    position:relative;
    background:#ffe6ec;
    border-radius:15px;
    box-shadow:0 20px 40px rgba(217,127,139,0.4);
    cursor:pointer;
    perspective:1000px;
    display:flex;
    justify-content:center;
    align-items:center;
    font-family:'Patrick Hand', cursive;
    font-size:2em;
    color:#d97f8b;
    text-shadow:1px 1px 3px #fff;
    user-select:none;
    transition: transform 0.3s, opacity 0.3s;
}

.envelope.locked{
    pointer-events:none;
    opacity:0.5;
}

.envelope:hover{
    transform: scale(1.03);
}

/* Envelope flap */
.envelope::before{
    content:'';
    position:absolute;
    top:0;
    left:0;
    width:100%;
    height:50%;
    background:#ffc2be;
    clip-path: polygon(0 0, 100% 0, 50% 100%);
    transform-origin:top;
    transition: transform 1s ease;
}

.envelope.open::before{
    transform: rotateX(180deg);
}

/* Bounce text */
.envelope span{
    pointer-events:none;
    animation: bounce 1.5s infinite;
}

@keyframes bounce{
    0%,100%{ transform: translateY(10px); }
    50%{ transform: translateY(0); }
}

/* Letter */
.letter{
    max-width:700px;
    margin:30px auto;
    background:#fff;
    border-radius:25px;
    padding:30px;
    font-family:'Patrick Hand', cursive;
    font-size:1.4em;
    line-height:1.8em;
    box-shadow:0 15px 35px rgba(217,127,139,0.4);
    display:none;
    opacity:0;
    transition: opacity 0.8s ease;
}

.letter h2{
    font-family:'Dancing Script', cursive;
    font-size:3em;
    color:#d97f8b;
}

/* Responsive */
@media(max-width:400px){
    .envelope{ width:90%; height:180px; font-size:1.6em; }
    #pageHeader{ font-size:2em; }
    #questionBox h2{ font-size:2em; }
}
</style>
</head>
<body>

<!-- Music -->
<audio id="bgMusic" loop>
    <source src="{% static 'sounds/SayYes.mp3' %}" type="audio/mpeg">
</audio>

<!-- Flap sound -->
<audio id="flapSound">
    <source src="{% static 'sounds/flap.mp3' %}" type="audio/mpeg">
</audio>

<!-- Decorative header -->
<div id="pageHeader">Will you be my Valentine? </div>

<!-- QUESTION -->
<div id="questionBox">
    <button onclick="answerYes()">Yes ðŸ’•</button>
    <button id="noBtn">No !!!</button>
</div>

<!-- ENVELOPE -->
<div class="envelope locked" id="envelope">
    <span id="tapText">Answer first ðŸ’Œ</span>
</div>

<!-- LETTER -->
<div class="letter" id="letter">
    {% if result %}
        <h2>{{ result.title }}</h2>
        <div id="letterText" data-text="{{ result.love_letter|escapejs }}"></div>
    {% endif %}
</div>

<script>
const envelope = document.getElementById("envelope");
const letter = document.getElementById("letter");
const textEl = document.getElementById("letterText");
const tapText = document.getElementById("tapText");
const flap = document.getElementById("flapSound");
const music = document.getElementById("bgMusic");
const noBtn = document.getElementById("noBtn");
const questionBox = document.getElementById("questionBox");

const text = textEl ? textEl.dataset.text : "";
let i = 0;
let musicStarted = false;

/* YES */
function answerYes(){
    questionBox.style.display = "none";
    envelope.classList.remove("locked");
    tapText.innerText = "Tap to open ðŸ’–";
}

/* NO button run away */
noBtn.addEventListener("mouseover", moveNo);
noBtn.addEventListener("click", moveNo);

function moveNo(){
    const boxRect = questionBox.getBoundingClientRect();
    const maxX = boxRect.width - noBtn.offsetWidth;
    const maxY = boxRect.height - noBtn.offsetHeight;

    const x = Math.random() * maxX;
    const y = Math.random() * maxY;

    noBtn.style.left = `${x}px`;
    noBtn.style.top = `${y}px`;
}

/* Music fade in */
function startMusic(){
    if(!musicStarted){
        music.volume = 0;
        music.play().then(()=>{
            let v=0;
            const fade = setInterval(()=>{
                v += 0.01;
                music.volume = v;
                if(v>=0.3) clearInterval(fade);
            },200);
        });
        musicStarted = true;
    }
}

/* Music fade out */
function fadeOutMusic(){
    if(musicStarted){
        let v = music.volume;
        const fade = setInterval(()=>{
            v -= 0.02;
            if(v <= 0){
                music.pause();
                music.currentTime = 0;
                clearInterval(fade);
            } else music.volume = v;
        },100);
        musicStarted = false;
    }
}

/* Typewriter */
function typeWriter(){
    if(i < text.length){
        textEl.innerHTML += text.charAt(i);
        i++;
        setTimeout(typeWriter, 80);
    }
}

/* Envelope click */
envelope.addEventListener("click", ()=>{
    flap.currentTime = 0;
    flap.play();

    if(envelope.classList.contains("open")){
        // Close envelope
        envelope.classList.remove("open");
        letter.style.opacity = 0;
        fadeOutMusic();  // fade out when closing
        setTimeout(()=>{
            letter.style.display = "none";
            i = 0;
            textEl.innerHTML = "";
        },600);
    } else {
        // Open envelope
        envelope.classList.add("open");
        startMusic(); // âœ… music starts only when envelope opens
        setTimeout(()=>{
            letter.style.display = "block";
            setTimeout(()=>letter.style.opacity = 1,50);
            typeWriter();
        },800);
    }
});
</script>

</body>
</html>