{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>My Magical Love Letter</title>

<link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@700&family=Patrick+Hand&family=Playfair+Display:wght@400;700&display=swap" rel="stylesheet">

<style>
body{
    margin:0;
    padding:0;
    font-family:"Playfair Display", serif;
    background: linear-gradient(135deg,#fff0f8,#ffe0e6);
    text-align:center;
    color:#740e28;
    overflow-x:hidden;
}

/* Page title */
h1{
    margin-top:30px;
    font-size:3em;
    color:#d97f8b;
    text-shadow:2px 2px 10px #ffc2be;
}

/* Envelope */
.envelope{
    width:340px;
    height:220px;
    margin:30px auto;
    position:relative;
    background:#ffe6ec;
    border-radius:15px;
    box-shadow:0 20px 40px rgba(217,127,139,0.4);
    cursor:pointer;
    perspective:1000px;
    display:flex;
    justify-content:center;
    align-items:center;
    font-family:'Patrick Hand', cursive;
    font-size:2em;
    color:#d97f8b;
    text-shadow:1px 1px 3px #fff;
    user-select:none;
    transition: transform 0.3s;
}

.envelope:hover{
    transform: scale(1.03);
}

/* Envelope flap */
.envelope::before{
    content:'';
    position:absolute;
    top:0;
    left:0;
    width:100%;
    height:50%;
    background:#ffc2be;
    clip-path: polygon(0 0, 100% 0, 50% 100%);
    transform-origin:top;
    transform: rotateX(0deg);
    transition: transform 1s ease, box-shadow 0.5s ease;
    box-shadow: inset 0 5px 15px rgba(0,0,0,0.05);
}

.envelope.open::before{
    transform: rotateX(180deg);
}

/* Tap text inside envelope */
.envelope span{
    pointer-events:none;
    transform: translateY(15px);
    animation: bounce 1.5s infinite ease-in-out;
    display:inline-block;
}

/* Tap animation */
@keyframes bounce{
    0%,100%{ transform: translateY(15px); }
    50%{ transform: translateY(5px); }
}

/* Letter */
.letter{
    max-width:700px;
    margin:30px auto;
    background:#fff;
    border-radius:25px;
    padding:30px;
    font-family:'Patrick Hand', cursive;
    font-size:1.4em;
    line-height:1.8em;
    box-shadow:0 15px 35px rgba(217,127,139,0.4);
    display:none;
    opacity:0;
    transition: opacity 0.8s ease;
}

/* Love letter title */
h2{
    font-family:'Dancing Script', cursive;
    font-size:3em;
    color:#d97f8b;
    margin-bottom:15px;
}

/* Back button */
button{
    padding:12px 25px;
    border:none;
    border-radius:18px;
    background:#d97f8b;
    color:#fff;
    font-size:1.1em;
    cursor:pointer;
    box-shadow:0 6px 18px rgba(217,127,139,0.4);
    transition: transform 0.3s, background 0.3s;
}
button:hover{
    background:#ffc2be;
    color:#740e28;
    transform: scale(1.05);
}

/* Responsive */
@media(max-width:400px){
    .envelope{ width:90%; height:180px; font-size:1.6em; }
    h1{ font-size:2em; }
    h2{ font-size:2em; }
}
</style>
</head>
<body>

<!-- Background Song -->
<audio id="bgMusic" loop>
    <source src="{% static 'sounds/SayYes.mp3' %}" type="audio/mpeg">
</audio>

<!-- Flap sound -->
<audio id="flapSound">
    <source src="{% static 'sounds/flap.mp3' %}" type="audio/mp3">
</audio>

<h1>üíå My Magical Love Letter for My Little Prince üíå</h1>

<div class="envelope" id="envelope"><span>Tap Here!</span></div>

<div class="letter" id="letter">
    {% if result %}
        <h2>{{ result.title }}</h2>
        <div id="letterText" data-text="{{ result.love_letter|escapejs }}"></div>
    {% endif %}
</div>

<br>
<button onclick="window.location.href='{% url 'clear_session' %}'">‚Üê Back</button>

<script>
const music = document.getElementById("bgMusic");
const flap = document.getElementById("flapSound");
const envelope = document.getElementById("envelope");
const letter = document.getElementById("letter");
const textEl = document.getElementById("letterText");
const text = textEl ? textEl.dataset.text : "";
let i=0;
let musicStarted=false;

function fadeInMusic(){
    if(!musicStarted){
        music.volume = 0;
        music.play().then(()=>{
            let v=0;
            const fade = setInterval(()=>{
                if(v>=0.3) clearInterval(fade);
                music.volume=v;
                v+=0.01;
            },200);
        }).catch(()=>{});
        musicStarted=true;
    }
}

function fadeOutMusic(){
    if(musicStarted){
        let v = music.volume;
        const fade = setInterval(()=>{
            v -= 0.02;
            if(v <= 0){
                music.pause();
                music.currentTime = 0;
                clearInterval(fade);
            } else music.volume = v;
        },100);
        musicStarted=false;
    }
}

function typeWriter(){
    if(i < text.length){
        textEl.innerHTML += text.charAt(i);
        i++;
        setTimeout(typeWriter,80);
    }
}

envelope.addEventListener("click", ()=>{
    flap.currentTime=0; flap.play();
    if(envelope.classList.contains("open")){
        // close
        envelope.classList.remove("open");
        letter.style.opacity=0;
        setTimeout(()=>{
            letter.style.display="none";
            fadeOutMusic();
            i=0;
            if(textEl) textEl.innerHTML="";
        },600);
    } else {
        // open
        envelope.classList.add("open");
        fadeInMusic();
        setTimeout(()=>{
            letter.style.display="block";
            setTimeout(()=>letter.style.opacity=1,50);
            typeWriter();
        },800);
    }
});

// fallback start music
document.addEventListener("click", fadeInMusic, { once:true });
</script>
</body>
</html>